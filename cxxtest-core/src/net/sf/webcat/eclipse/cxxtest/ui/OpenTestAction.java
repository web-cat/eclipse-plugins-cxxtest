/*
 *	This file is part of Web-CAT Eclipse Plugins.
 *
 *	Web-CAT is free software; you can redistribute it and/or modify
 *	it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation; either version 2 of the License, or
 *	(at your option) any later version.
 *
 *	Web-CAT is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	You should have received a copy of the GNU General Public License
 *	along with Web-CAT; if not, write to the Free Software
 *	Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 */
package net.sf.webcat.eclipse.cxxtest.ui;

import net.sf.webcat.eclipse.cxxtest.model.ICxxTestAssertion;
import net.sf.webcat.eclipse.cxxtest.model.ICxxTestMethod;
import net.sf.webcat.eclipse.cxxtest.model.ICxxTestStackFrame;
import net.sf.webcat.eclipse.cxxtest.model.ICxxTestSuite;

import org.eclipse.cdt.core.model.CModelException;
import org.eclipse.cdt.core.model.ICProject;
import org.eclipse.cdt.internal.ui.util.EditorUtility;
import org.eclipse.core.resources.IFile;
import org.eclipse.jface.action.Action;
import org.eclipse.jface.text.BadLocationException;
import org.eclipse.jface.text.IDocument;
import org.eclipse.ui.PartInitException;
import org.eclipse.ui.texteditor.ITextEditor;

/**
 * A JFace action that opens the text editor and positions the cursor at the
 * requested CxxTest result.
 * 
 * @author Tony Allowatt (Virginia Tech Computer Science)
 */
public class OpenTestAction extends Action
{
	private Object test;

	private TestRunnerViewPart testRunnerView;

	public OpenTestAction(TestRunnerViewPart testRunnerView, Object test)
	{
		this.testRunnerView = testRunnerView;
		this.test = test;

		setText("Open in Editor");
		setToolTipText("Open Suite in Text Editor");
	}

	public void run()
	{
		String filename = "";
		int lineNumber = 1;

		if(test instanceof ICxxTestSuite)
		{
			filename = ((ICxxTestSuite)test).getFile();
			lineNumber = ((ICxxTestSuite)test).getLineNumber();
		}
		else if(test instanceof ICxxTestMethod)
		{
			filename = ((ICxxTestSuite)
					((ICxxTestMethod)test).getParent()).getFile();
			lineNumber = ((ICxxTestMethod)test).getLineNumber();
		}
		else if(test instanceof ICxxTestAssertion)
		{
			ICxxTestMethod method =
				(ICxxTestMethod)((ICxxTestAssertion)test).getParent();
			ICxxTestSuite suite = (ICxxTestSuite)method.getParent();

			filename = suite.getFile();
			lineNumber = ((ICxxTestAssertion)test).getLineNumber();
		}
		else if(test instanceof ICxxTestStackFrame)
		{
			ICxxTestStackFrame sf = (ICxxTestStackFrame)test;
			
			filename = sf.getFile();
			lineNumber = sf.getLineNumber();
		}

		if(filename == null || filename.length() == 0)
			return;

		ICProject project = testRunnerView.getLaunchedProject();
		IFile file = project.getProject().getFile(filename);
		
		try
		{
			ITextEditor editor =
				(ITextEditor)EditorUtility.openInEditor(file, true);

			try
			{
				IDocument document= editor.getDocumentProvider().
					getDocument(editor.getEditorInput());
				
				editor.selectAndReveal(
						document.getLineOffset(lineNumber - 1),
						document.getLineLength(lineNumber - 1));
			}
			catch(BadLocationException x) { }
		}
		catch (PartInitException e) { }
		catch (CModelException e) { }
	}
}
